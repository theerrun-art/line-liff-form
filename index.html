<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6">
        <h2 id="formTitle" class="text-xl font-bold mb-4 text-center text-gray-700">üìù ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>
        
        <form id="mainForm" class="space-y-4">
            
            <div>
                <label class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" id="dateInput" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
            </div>

            <div id="jobFields" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)</label>
                    <input type="number" id="qtyInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <input type="text" id="shopInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πä‡πÇ‡∏ö‡∏ß‡πå" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                </div>
            </div>

            <div id="transferFields" class="hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="amountInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô" class="mt-1 block w-full rounded-md border-green-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50 p-2 border">
                </div>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded transition duration-300">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </form>
    </div>

    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ---
        // üö® ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÅ‡∏Å‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå Webhook ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
        const N8N_WEBHOOK_URL = 'https://114021417720.ngrok-free.app/webhook-test/line-branch-1'; 
        const LIFF_ID = '2008942602-XZnTQc1s'; 

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode'); // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ ?mode=... ‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå

        async function main() {
            await liff.init({ liffId: LIFF_ID });
            document.getElementById('dateInput').valueAsDate = new Date();
            
            if (!liff.isLoggedIn()) {
                liff.login();
            }

            // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î ---
            const title = document.getElementById('formTitle');
            const btn = document.getElementById('submitBtn');
            const jobFields = document.getElementById('jobFields');
            const transferFields = document.getElementById('transferFields');
            const qtyInput = document.getElementById('qtyInput');
            const shopInput = document.getElementById('shopInput');
            const amountInput = document.getElementById('amountInput');

            if (mode === 'transfer') {
                // ‡πÇ‡∏´‡∏°‡∏î: ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô
                title.innerText = 'üí∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô';
                title.className = "text-xl font-bold mb-4 text-center text-green-700";
                btn.className = "w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300";
                
                // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                jobFields.classList.add('hidden');
                transferFields.classList.remove('hidden');
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Required (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå)
                amountInput.required = true;
                qtyInput.required = false;
                shopInput.required = false;

            } else {
                // ‡πÇ‡∏´‡∏°‡∏î: ‡∏á‡∏≤‡∏ô (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
                title.innerText = 'üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô';
                title.className = "text-xl font-bold mb-4 text-center text-blue-700";
                btn.className = "w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300";

                // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                jobFields.classList.remove('hidden');
                transferFields.classList.add('hidden');

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Required
                amountInput.required = false;
                qtyInput.required = true;
                shopInput.required = true;
            }
        }

        document.getElementById('mainForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
            let formData = {
                date: document.getElementById('dateInput').value,
                userId: liff.getContext()?.userId,
                // ‡∏™‡πà‡∏á‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ n8n ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£
                formType: mode === 'transfer' ? 'transfer' : 'job' 
            };

            if (mode === 'transfer') {
                formData.amount = document.getElementById('amountInput').value; // ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
                formData.item = '‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'; // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            } else {
                formData.quantity = document.getElementById('qtyInput').value; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô
                formData.shop = document.getElementById('shopInput').value;    // ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
            }

            try {
                await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify(formData)
                });

                alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                liff.closeWindow(); 

            } catch (err) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
                submitBtn.disabled = false;
                submitBtn.innerText = '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
            }
        });

        main();
    </script>
</body>
</html>
