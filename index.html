<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö */
        body {
            font-family: 'Mali', cursive;
        }
        /* ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ */
        .cute-pattern {
            background-color: #fff1f2; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô */
            background-image: radial-gradient(#fbcfe8 2px, transparent 2px);
            background-size: 20px 20px;
        }
        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏∏‡∏ö‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á */
        .btn-bounce:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="cute-pattern min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-white rounded-[2rem] shadow-xl overflow-hidden border-4 border-white relative">
        
        <div id="headerBg" class="h-24 bg-blue-200 flex items-center justify-center relative overflow-hidden">
            <div class="absolute top-[-20px] left-[-20px] w-16 h-16 bg-white opacity-20 rounded-full"></div>
            <div class="absolute bottom-[-10px] right-[-10px] w-20 h-20 bg-white opacity-20 rounded-full"></div>
            
            <h2 id="formTitle" class="text-2xl font-bold text-white drop-shadow-md relative z-10 mt-2">
                üìù ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
            </h2>
        </div>

        <div class="p-6 pt-8">
            <form id="mainForm" class="space-y-5">
                
                <div class="relative">
                    <label class="block text-gray-600 font-bold mb-1 ml-1">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="dateInput" required 
                        class="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl p-3 focus:outline-none focus:border-pink-300 focus:ring-2 focus:ring-pink-100 transition-all text-gray-700">
                </div>

                <div id="jobFields" class="space-y-5">
                    <div>
                        <label class="block text-gray-600 font-bold mb-1 ml-1">üí∞ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="qtyInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 1500)" 
                            class="w-full bg-blue-50 border-2 border-blue-100 rounded-2xl p-3 focus:outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-100 transition-all text-gray-700 placeholder-blue-300">
                    </div>
                    <div>
                        <label class="block text-gray-600 font-bold mb-1 ml-1">üè™ ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="text" id="shopInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πä‡πÇ‡∏ö‡∏ß‡πå" 
                            class="w-full bg-pink-50 border-2 border-pink-100 rounded-2xl p-3 focus:outline-none focus:border-pink-300 focus:ring-2 focus:ring-pink-100 transition-all text-gray-700 placeholder-pink-300">
                    </div>
                </div>

                <div id="transferFields" class="hidden space-y-5">
                    <div>
                        <label class="block text-gray-600 font-bold mb-1 ml-1">üíµ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="amountInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô" 
                            class="w-full bg-green-50 border-2 border-green-100 rounded-2xl p-3 focus:outline-none focus:border-green-300 focus:ring-2 focus:ring-green-100 transition-all text-gray-700 placeholder-green-300">
                    </div>
                </div>

                <button type="submit" id="submitBtn" 
                    class="w-full btn-bounce bg-gray-400 text-white font-bold text-lg py-3 px-4 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 mt-4 border-b-4 border-gray-500 active:border-b-0 active:translate-y-1">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚ú®
                </button>
            </form>
        </div>
        
        <div class="text-center pb-4 text-xs text-gray-300 font-light">
            Powered by n8n & LIFF
        </div>
    </div>

    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏¥‡∏á‡∏Å‡πå Webhook ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö) ---
        const N8N_WEBHOOK_URL = 'https://114021417720.ngrok-free.app/webhook-test/line-branch-1'; 
        const LIFF_ID = '2008942602-XZnTQc1s'; 

        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode'); 

        async function main() {
            await liff.init({ liffId: LIFF_ID });
            document.getElementById('dateInput').valueAsDate = new Date();
            
            if (!liff.isLoggedIn()) {
                liff.login();
            }

            // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤ ---
            const headerBg = document.getElementById('headerBg');
            const title = document.getElementById('formTitle');
            const btn = document.getElementById('submitBtn');
            const jobFields = document.getElementById('jobFields');
            const transferFields = document.getElementById('transferFields');
            const qtyInput = document.getElementById('qtyInput');
            const shopInput = document.getElementById('shopInput');
            const amountInput = document.getElementById('amountInput');

            if (mode === 'transfer') {
                // üíö ‡∏ò‡∏µ‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå‡∏™‡∏î‡πÉ‡∏™)
                title.innerText = 'üí∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô';
                headerBg.className = "h-24 bg-gradient-to-r from-green-300 to-teal-300 flex items-center justify-center relative overflow-hidden";
                btn.className = "w-full btn-bounce bg-gradient-to-r from-green-400 to-teal-400 text-white font-bold text-lg py-3 px-4 rounded-2xl shadow-green-200 hover:shadow-xl transition-all duration-300 border-b-4 border-green-600 active:border-b-0 active:translate-y-1";
                
                jobFields.classList.add('hidden');
                transferFields.classList.remove('hidden');
                
                amountInput.required = true;
                qtyInput.required = false;
                shopInput.required = false;

            } else {
                // ü©µ ‡∏ò‡∏µ‡∏°‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ü‡πâ‡∏≤‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏• - ‡∏ä‡∏°‡∏û‡∏π)
                title.innerText = 'üßæ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                headerBg.className = "h-24 bg-gradient-to-r from-blue-300 to-pink-300 flex items-center justify-center relative overflow-hidden";
                btn.className = "w-full btn-bounce bg-gradient-to-r from-blue-400 to-indigo-400 text-white font-bold text-lg py-3 px-4 rounded-2xl shadow-blue-200 hover:shadow-xl transition-all duration-300 border-b-4 border-blue-600 active:border-b-0 active:translate-y-1";

                jobFields.classList.remove('hidden');
                transferFields.classList.add('hidden');

                amountInput.required = false;
                qtyInput.required = true;
                shopInput.required = true;
            }
        }

        document.getElementById('mainForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = 'üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            submitBtn.classList.add('opacity-75');

            let formData = {
                date: document.getElementById('dateInput').value,
                userId: liff.getContext()?.userId,
                formType: mode === 'transfer' ? 'transfer' : 'job' 
            };

            if (mode === 'transfer') {
                formData.amount = document.getElementById('amountInput').value; 
                formData.item = '‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'; 
            } else {
                formData.quantity = document.getElementById('qtyInput').value; 
                formData.shop = document.getElementById('shopInput').value;    
            }

            try {
                await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify(formData)
                });

                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ
                alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! \n‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏∞‡∏Ñ‡∏∞ ‚ú®');
                liff.closeWindow(); 

            } catch (err) {
                alert('‡πÅ‡∏¢‡πà‡∏à‡∏±‡∏á! ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
                submitBtn.disabled = false;
                submitBtn.innerText = '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á üîÑ';
                submitBtn.classList.remove('opacity-75');
            }
        });

        main();
    </script>
</body>
</html>
